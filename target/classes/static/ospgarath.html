<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Osp-Garath</title>

    <link rel="stylesheet" href="css/ospgarath_style.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/rpg-awesome.css">
    <link rel="stylesheet" type="text/css" href="tooltipster/dist/css/tooltipster.bundle.min.css" />
    <link rel="stylesheet" href="tooltipster/dist/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-borderless.min.css"/>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script type="text/javascript" src="tooltipster/dist/js/tooltipster.bundle.min.js"></script>
    <script type="text/javascript" src="js/tooltipster-discovery.min.js"></script>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>-->

</head>
<style>
    body {
        background: url("img/game_background2.jpg"), no-repeat;
        -webkit-background-size: 100%;
        background-size: 100%;
    }
    #board_container {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 101vh;
        height: 100vh;
        margin-top: -50vh;
        margin-left: -50vh;
        /*-webkit-box-shadow: 0px 0px 50px black;*/
        /*-moz-box-shadow: 0px 0px 50px black ;*/
        /*box-shadow: 0px 0px 50px black ;*/
    }

    #board_border {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 101vh;
        height: 100vh;
        margin-top: -50vh;
        margin-left: -50vh;
    }

    #current_board {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 92vh;
        height: 92vh;
        margin-top: -45.75vh;
        margin-left: -45.75vh;
        box-shadow: 0 0 50px white;
    }

    .attribute_bar {
        position: absolute;
        width: 30vh;
        height: 3vh;
    }

    #health {
        position: absolute;
        left: 2.45vh;
        top: 15vh;
        width: 29.3vh;
        height: 2.3vh;
    }

    #experience {
        position: absolute;
        left: 2.45vh;
        top: 18.3vh;
        width: 29.3vh;
        height: 2.4vh;
    }

    .ability_score {
        padding-left: .5vh;
    }

    #end_overlay {
        position: absolute;
        font-size: 10pt;
        left: 13vh;
        top: 15.1vh;
    }

    #exp_overlay {
        position: absolute;
        font-size: 10pt;
        left: 14vh;
        top: 18.5vh;
    }

    #character_icon {
        position: absolute;
        left: 47.2vh;
        top: 89.6vh;
        width: 6.85vh;
        height: 6.5vh;
        box-shadow: 0 2px 15px 3px black;
    }

    #actions_status {
        position: absolute;
        left: 5.5vh;
        top: 5vh;
        font-size: 14pt;
    }

    #movement_arrows {
        position: absolute;
        left: 78vh;
        top: 85vh;
    }

    .arrows {
        width: 4.5vh;
        height: 4.5vh;
    }

    .tooltip {
        font-family: 'Marcellus SC', serif;
        color: yellow;
        cursor: default;
    }

    .tooltip:hover {
        text-shadow: 0 0 5px yellow;
    }

    .action_list {
        text-align:center;
        color: yellow;
        font-family: 'Marcellus SC', serif;
        cursor: default;
    }

    .action:hover {
        text-shadow: 0 0 5px yellow;
    }

    .hidden {
        display: none;
    }

    #end_turn_button {
        text-align: center;
        background: url("img/button_new2.jpg") no-repeat;
        color: yellow;
        font-family: 'Marcellus SC', serif;
        cursor: default;
        background-size: contain;
        outline: none;
        border: none;
        font-size: 10pt;
        width: 14vh;
        height: 6vh;
    }

    #end_turn_button:hover {
        text-shadow: 0 0 5px yellow;
        box-shadow: 0 0 5px yellow;
    }

    #end_turn_button:active {
        background: url("img/button_new_clicked.jpg");
        background-size: contain;
        width: 14vh;
        height: 6vh;
    }

    #end_turn_container {
        position: absolute;
        left: 8vh;
        top: 89.6vh;
    }

</style>
<script>
    var VERTICAL_INCREASE = 7.11;
    var HORIZONTAL_INCREASE = 7.15;
    var START_X = 0;
    var START_Y = -6;
    var CHAR_X = 0;
    var CHAR_Y = -6;

    var BASE_MOVEMENT = 6;
    var MOVEMENT = 6;
    var ACTION_MENU_VISIBLE = false;
    var CLICK_TO_MOVE = false;

    var ENEMIES = [{'position': {'x':0, 'y':1}}];
    var OFF_LIMIT_SQUARES = [];

    function activateActionsOptionsTooltipster() {
        var $character = $('#character_icon');
        if (ACTION_MENU_VISIBLE) {
            clearActiveTooltipsters();
            return;
        }

        //Quick-Left
        $character.tooltipster({
            theme: 'tooltipster-borderless',
            animation: 'grow',
            trigger: 'click',
            side: 'left',
            content: $('<span class="tooltip">Quick Action</span>'),
            multiple: true,
            interactive: true,
            functionReady: function(instance, helper){
                // the nested tooltip must be initialized once the first tooltip is open, that's why we do this inside functionReady()
                instance.content().tooltipster({
                    theme: 'tooltipster-borderless',
                    content: getQuickActions(),
                    distance: 0,
                    side: 'bottom',
                    interactive: true,
                    trigger: 'click'
                });
            },
            functionAfter: function(instance, helper) {
                this.destroy();
                ACTION_MENU_VISIBLE = false; //only needed once
            }
        });

        //Move-Top
        $character.tooltipster({
            theme: 'tooltipster-borderless',
            animation: 'grow',
            trigger: 'click',
            side: 'top',
            content: $('<span class="tooltip" onclick="showPossibleMovements()">Move</span>'),
            multiple: true,
            interactive: true,
            functionAfter: function(instance, helper) {
                this.destroy();
            }
        });

        //Standard-Right
        $character.tooltipster({
            theme: 'tooltipster-borderless',
            animation: 'grow',
            trigger: 'click',
            side: 'right',
            content: $('<span class="tooltip">Standard Action</span>'),
            multiple: true,
            interactive: true,
            functionReady: function(instance, helper) {
                // the nested tooltip must be initialized once the first tooltip is open, that's why we do this inside functionReady()
                instance.content().tooltipster({
                    theme: 'tooltipster-borderless',
                    content: getStandardActions(),
                    distance: 0,
                    side: 'bottom',
                    interactive: true,
                    trigger: 'click'
                });
            },
            functionAfter: function(instance, helper) {
                this.destroy();
            }
        });

        var instances = $.tooltipster.instances($character);
        for (var i = 0; i < instances.length; i++) {
            instances[i].open();
        }
        ACTION_MENU_VISIBLE = true;
    }

    function clearActiveTooltipsters() {
        var $character = $('#character_icon');
        var current_instances = $.tooltipster.instances($character);
        for (var j = 0; j < current_instances.length; j++) {
            current_instances[j].close();
        }
    }

    function getStandardActions() {
        var actionContainer = document.createElement("div");
        var action1 = document.createElement("p");
        var action2 = document.createElement("p");

        action1.innerText = "Attack";
        action2.innerText = "Pass";
        actionContainer.appendChild(action1);
        actionContainer.appendChild(action2);
        action1.classList.add("action");
        action2.classList.add("action");
        actionContainer.classList.add("action_list");
        return actionContainer;
    }

    function getQuickActions() {
        var actionContainer = document.createElement("div");
        var action1 = document.createElement("p");
        var action2 = document.createElement("p");

        action1.innerText = "Equip Item";
        action2.innerText = "Search Body";
        actionContainer.appendChild(action1);
        actionContainer.appendChild(action2);
        action1.classList.add("action");
        action2.classList.add("action");
        actionContainer.classList.add("action_list");
        return actionContainer;
    }

    document.addEventListener('keydown', function(event) {
        hidePossibleMovements();
        //left
        if (event.keyCode === 37) {
            moveCharacter("left");
        }
        //up
        if (event.keyCode === 38) {
            moveCharacter("up");
        }
        //right
        if (event.keyCode === 39) {
            moveCharacter("right");
        }
        //down
        if (event.keyCode === 40) {
            moveCharacter("down");
        }
    });

    document.addEventListener('keyup', function(event) {
        //left
        if (event.keyCode === 37) {
            arrow_button_up("left");
        }
        //up
        if (event.keyCode === 38) {
            arrow_button_up("up");
        }
        //right
        if (event.keyCode === 39) {
            arrow_button_up("right");
        }
        //down
        if (event.keyCode === 40) {
            arrow_button_up("down");
        }

    });

    function getViewHeight(input) {
        var split = input.split('px');
        var pixels = split[0];

        return pixelsToViewHeight(pixels);
    }

    function pixelsToViewHeight(pixels) {
        return parseFloat((pixels/ $(window).height()) / 0.01);
    }

    function canMoveLeft() {
        if (!checkObstacles(CHAR_X-1, CHAR_Y) || !checkEnemies(CHAR_X-1, CHAR_Y))
            return false;
        if (!movementSpeedRemaining(CHAR_X-1, CHAR_Y))
            return false;
        if (CHAR_X === -6)
            return false;
        if (CHAR_X === -5 && Math.abs(CHAR_Y) === 4)
            return false;
        if (CHAR_X === -4 && Math.abs(CHAR_Y) === 5)
            return false;
        if (CHAR_X === -3 && Math.abs(CHAR_Y) === 6)
            return false;
        return true;
    }

    function canMoveRight() {
        if (!checkObstacles(CHAR_X+1, CHAR_Y) || !checkEnemies(CHAR_X+1, CHAR_Y))
            return false;
        if (!movementSpeedRemaining(CHAR_X+1, CHAR_Y))
            return false;
        if (CHAR_X === 6)
            return false;
        if (CHAR_X === 5 && Math.abs(CHAR_Y) === 4)
            return false;
        if (CHAR_X === 4 && Math.abs(CHAR_Y) === 5)
            return false;
        if (CHAR_X === 3 && Math.abs(CHAR_Y) === 6)
            return false;
        return true;
    }

    function canMoveUp() {
        if (!checkObstacles(CHAR_X, CHAR_Y+1) || !checkEnemies(CHAR_X, CHAR_Y+1))
            return false;
        if (!movementSpeedRemaining(CHAR_X, CHAR_Y+1))
            return false;
        if (CHAR_Y === 6)
            return false;
        if (CHAR_Y === 5 && Math.abs(CHAR_X) === 4)
            return false;
        if (CHAR_Y === 4 && Math.abs(CHAR_X) === 5)
            return false;
        if (CHAR_Y === 3 && Math.abs(CHAR_X) === 6)
            return false;
        return true;
    }

    function canMoveDown() {
        if (!checkObstacles(CHAR_X, CHAR_Y-1) || !checkEnemies(CHAR_X, CHAR_Y-1))
            return false;
        if (!movementSpeedRemaining(CHAR_X, CHAR_Y-1))
            return false;
        if (CHAR_Y === -6)
            return false;
        if (CHAR_Y === -5 && Math.abs(CHAR_X) === 4)
            return false;
        if (CHAR_Y === -4 && Math.abs(CHAR_X) === 5)
            return false;
        if (CHAR_Y === -3 && Math.abs(CHAR_X) === 6)
            return false;
        return true;
    }

    function movementSpeedRemaining(possible_x, possible_y) {
        var vert = Math.abs(possible_y - START_Y);
        var hor = Math.abs(possible_x - START_X);
        return ((vert+hor) <= MOVEMENT);
    }

    function movementSpeedRemainingPlusOne(possible_x, possible_y) {
        var vert = Math.abs(possible_y - START_Y);
        var hor = Math.abs(possible_x - START_X);
        return ((vert+hor) <= MOVEMENT+1);
    }

    function movementRemaining() {
        var vert = Math.abs(CHAR_Y - START_Y);
        var hor = Math.abs(CHAR_X - START_X);
        return MOVEMENT - (vert+hor);
    }

    function moveCharacter(direction) {
        // var char_icon = document.getElementById("character_icon"),
        //     style = window.getComputedStyle(char_icon);

        // var current_left = getViewHeight(style.getPropertyValue('left'));
        // var current_top = getViewHeight(style.getPropertyValue('top'));

        switch (direction) {
            case "left":
                if (!canMoveLeft()) {
                    return;
                }
                CHAR_X--;
                break;
            case "up":
                if (!canMoveUp()) {
                    return;
                }
                CHAR_Y++;
                break;
            case "right":
                if (!canMoveRight()) {
                    return;
                }
                CHAR_X++;
                break;
            case "down":
                if (!canMoveDown()) {
                    return;
                }
                CHAR_Y--;
                break;
        }
        placeCharacter(CHAR_X, CHAR_Y);
        clearActiveTooltipsters();
        arrow_button_down(direction);
        updateMovementRemaining();
    }

    function arrow_button_down(direction) {
        var arrow_button = document.getElementById(direction + "_arrow");
        arrow_button.src = "img/" + direction + "_button_pressed.jpg";
    }

    function arrow_button_up(direction) {
        var arrow_button = document.getElementById(direction + "_arrow");
        arrow_button.src = "img/" + direction + "_button.jpg";
    }

    function arrow_clicked(direction) {
        if (CLICK_TO_MOVE) {
            hidePossibleMovements();
            CLICK_TO_MOVE = false;
        }
        moveCharacter(direction);
    }

    function arrow_released(direction) {
        arrow_button_up(direction);
    }

    function getViewPortPositionLeft(x) {
        return 47.2 + (HORIZONTAL_INCREASE * x);
    }

    function getViewPortPositionTop(y) {
        return 46.94 - (VERTICAL_INCREASE * y);
    }

    function placeCharacter(x, y) {
        if (!checkObstacles(x, y) || !checkEnemies(x, y)) {
            return false;
        }
        var char_icon = document.getElementById("character_icon");
        char_icon.style.left = (parseFloat(getViewPortPositionLeft(x))) + "vh";
        char_icon.style.top = (parseFloat(getViewPortPositionTop(y))) + "vh";
        CHAR_X = x;
        CHAR_Y = y;
        return true;
    }


    function getBoardSpaces() {
        $.get("game/board/spaces", function (data, status) {

        });
    }

    //create box overlay images
    $(document).ready(function() {
        var container = document.getElementById("box_overlays_container");

        $.get("game/board/spaces", function (data, status) {
            for (var i = 0; i < data.length; i++) {
                var x, y, space;
                space = data[i];
                x = space.x;
                y = space.y;

                var div = document.createElement("div");
                div.id = x + "," + y;
                div.style.position = "absolute";
                div.style.left = parseFloat(getViewPortPositionLeft(x)) + "vh";
                div.style.top = parseFloat(getViewPortPositionTop(y)) + "vh";
                div.classList.add("hidden");
                var img = document.createElement("img");
                setSquareColor(space.spaceInfo, img);
                img.id = "img" + x + "," + y;
                img.style = "width: 7.2vh; height: auto; opacity: .7;";
                img.setAttribute("onclick", "clickToMove(" + x + ", " + y + ")");
                div.appendChild(img);
                container.appendChild(div);
            }
        });
    });

    function setSquareColor(spaceInfo, img) {
        switch (spaceInfo) {
            case "FREE":
                img.src = "img/blue_square.jpg";
                break;
            case "OCCUPIED":
                img.src = "img/red_square.jpg";
                break;
            case "OBSTACLE":
                img.src = "img/gray_square.jpg";
                break;
            case "INTERACTION":
                img.src = "img/purple_square.jpg";
                break;
        }
    }

    function showPossibleMovements() {
        $.get("move/possible", function (data, status) {
            for (var i = 0; i < data.length; i++) {
                var x, y, space;
                space = data[i];
                x = space.x;
                y = space.y;

                var box = document.getElementById(x + "," + y);
                box.classList.remove("hidden");
            }
            CLICK_TO_MOVE = true;
        });

        $.get("move/blocked", function (data, status) {
            for (var i = 0; i < data.length; i++) {
                var x, y, space;
                space = data[i];
                x = space.x;
                y = space.y;

                var box = document.getElementById(x + "," + y);
                box.classList.remove("hidden");
            }
        });

            // for (var i = -6; i <= 6; i++) {
            // for (var j = -6; j <= 6; j++) {
            //     if (Math.abs(i) + Math.abs(j) > 9) {
            //         continue;
            //     }
            //     if (i === CHAR_X && j === CHAR_Y) {
            //         continue;
            //     }
            //     if (movementSpeedRemaining(i, j)) {
            //         var box = document.getElementById(i + "," + j);
            //         box.classList.remove("hidden");
            //         var img = document.getElementById("img" + i + "," + j);
            //         if (!checkObstacles(i, j)) {
            //             img.src = "img/gray_square.jpg";
            //         }
            //         else if (!checkEnemies(i, j)) {
            //             img.src = "img/red_square.jpg";
            //         }
            //         else {
            //             img.src = "img/blue_square.jpg";
            //         }
            //     }
            //     if (movementSpeedRemainingPlusOne(i, j)) {
            //         if (!checkEnemies(i, j)) {
            //             var box2 = document.getElementById(i + "," + j);
            //             box2.classList.remove("hidden");
            //             var img2 = document.getElementById("img" + i + "," + j);
            //             img2.src = "img/red_square.jpg";
            //         }
            //     }
            // }
        // }
    }

    function checkObstacles(x, y) {
        for (i = 0; i < OFF_LIMIT_SQUARES.length; i++) {
            var square = OFF_LIMIT_SQUARES[i];
            if (square.x === x && square.y === y) {
                return false;
            }
        }
        return true;
    }

    function checkEnemies(x, y) {
        for (var i = 0; i < ENEMIES.length; i++) {
            var enemy = ENEMIES[i];
            if (enemy.position.x === x && enemy.position.y === y) {
                return false;
            }
        }
        return true;
    }

    function clearBoxColor(img) {
        img.classList.remove("red");
        img.classList.remove("blue");
        img.classList.remove("green");
        img.classList.remove("purple");
        img.classList.remove("gray");
    }

    function hidePossibleMovements() {
        for (var i = -6; i <= 6; i++) {
            for (var j = -6; j <= 6; j++) {
                if (Math.abs(i) + Math.abs(j) > 9) {
                    continue;
                }
                var box = document.getElementById(i + "," + j);
                box.classList.add("hidden");
                clearBoxColor(document.getElementById("img" + i + "," + j));
            }
        }
        CLICK_TO_MOVE = false;
    }

    function clickToMove(x, y) {
        if (!CLICK_TO_MOVE) {
            return;
        }
        if (!placeCharacter(x, y)) {
            return;
        }
        CHAR_X = x;
        CHAR_Y = y;
        hidePossibleMovements();
        updateMovementRemaining();
    }

    function updateMovementRemaining() {
        document.getElementById("movement_remaining").innerText = movementRemaining();
    }

    function endTurn() {
        //TODO: send info to back end
        START_X = CHAR_X;
        START_Y = CHAR_Y;
        MOVEMENT = BASE_MOVEMENT;
        updateMovementRemaining();
    }

</script>
<body>
    <div id="board_container">
        <img id="board_border" src="img/game_board.png">
        <img id="current_board" src="img/board1.png">
        <div id="character_icon" onclick="activateActionsOptionsTooltipster()">
            <img src="img/char_icon.jpg" style="width:6.85vh; height:6.85vh;">
        </div>
        <div id="actions_status" class="body_font">
            <span>Mov: <span id="movement_remaining">6</span></span><br>
            <span>Quick: <span id="quick_action_description">unused</span></span><br>
            <span>Std: <span id="std_action_description">unused</span></span><br>
        </div>
        <div id="end_turn_container">
            <button id="end_turn_button" onclick="endTurn()">End Turn</button>
        </div>
        <div id="movement_arrows">
            <table>
                <tr>
                    <td></td>
                    <td><img id="up_arrow" class="arrows" draggable="false" src="img/up_button.jpg" onmousedown="arrow_clicked('up')" onmouseup="arrow_released('up')"> </td>
                    <td></td>
                </tr>
                <tr>
                    <td><img id="left_arrow" class="arrows" draggable="false" src="img/left_button.jpg" onmousedown="arrow_clicked('left')" onmouseup="arrow_released('left')"></td>
                    <td><img id="down_arrow" class="arrows" draggable="false" src="img/down_button.jpg" onmousedown="arrow_clicked('down')" onmouseup="arrow_released('down')"></td>
                    <td><img id="right_arrow" class="arrows" draggable="false" src="img/right_button.jpg" onmousedown="arrow_clicked('right')" onmouseup="arrow_released('right')"></td>
                </tr>
            </table>
        </div>
        <div id="box_overlays_container"></div>
    </div>
    <div id="character_info" style="display: inline-flex;">
        <img src="img/char_border2.png" style="width:10vh;height:13vh;">
        <div id="char_name_container" class="header_font" style="margin-left:1vh;">
            <span id="char_name" style="font-size: 16pt;">New Character</span><br>
            <span id="player_name">Player Name</span><br><br>
            <span id="race_class">Race - Class</span>
        </div>
    </div>
    <div id="abilities_container" class="body_font" style="padding-left: 1vh;display: grid;">
        <img src="img/health_bar.png" class="attribute_bar" style="left:2vh; top:14.6vh;">
        <img src="img/health_bar.png" class="attribute_bar" style="left:2vh; top:17.9vh;">
        <img id="health" src="img/health_bar_fill.png">
        <img id="experience" src="img/exp_bar_fill.png">
        <span id="end_overlay">Endurance</span>
        <span id="exp_overlay">Level: <span id="char_level">1</span></span>
        <div style="position: absolute; left:2vh; top:22vh;">
            <div class="ability_score"><span>S: </span><span id="ability_s">10 (+0)</span></div>
            <div class="ability_score"><span>Q: </span><span id="ability_q">10 (+0)</span></div>
            <div class="ability_score"><span>I: </span><span id="ability_i">10 (+0)</span></div>
            <div class="ability_score"><span>L: </span><span id="ability_l">10 (+0)</span></div>
        </div>
    </div>

    <!--<span id="quick_action" class="tooltip">Quick Action</span>-->
    <div class="tooltip_templates" style="display: none;">
        <div id="action_option_content">
            <div id="action_option">
                <img src="" id="power_icon">
                <span id="tooltip_power_name"></span>
                <p id="tooltip_power_description"></p>
            </div>
        </div>
        <div id="action_list_content">
            <div id="action_list">
                <ul>
                    <li>List option</li>
                </ul>
            </div>
        </div>
    </div>

</body>
</html>